<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Paragraph Zen - Fast Save</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #ffffff; --text-color: #2c3e50;
            --sidebar-bg: #f8f9fa; --sidebar-border: #e9ecef;
            --accent: #007bff; --btn-hover: #f0f7ff;
            --modal-bg: rgba(255, 255, 255, 0.98);
            --note-color: #6c757d;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1a1a1a; --text-color: #d1d1d1;
                --sidebar-bg: #2d2d2d; --sidebar-border: #444;
                --accent: #3794ff; --btn-hover: #333;
                --modal-bg: rgba(30, 30, 30, 0.98);
                --note-color: #a0a0a0;
            }
        }

        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; display: flex; height: 100vh; overflow: hidden; background: var(--bg-color); color: var(--text-color); }

        /* --- Sidebar --- */
        #sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid var(--sidebar-border); display: flex; flex-direction: column; padding: 15px; box-sizing: border-box; }
        .nav-header { font-size: 11px; font-weight: bold; margin-bottom: 10px; opacity: 0.5; text-transform: uppercase; }
        .btn { border: 1px solid var(--sidebar-border); background: var(--bg-color); color: var(--text-color); padding: 10px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: 0.2s; display: block; width: 100%; text-align: center; box-sizing: border-box; margin-bottom: 8px; }
        .btn:hover { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-row { display: flex; gap: 8px; }
        .btn-row .btn { flex: 1; margin-bottom: 0; }
        #file-list { flex: 1; overflow-y: auto; margin: 10px 0; border-top: 1px solid var(--sidebar-border); padding-top: 10px; }
        .file-item { padding: 10px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; border: 1px solid transparent; }
        .file-item.active { background: var(--bg-color); border-color: var(--sidebar-border); color: var(--accent); }
        .storage-info { font-size: 10px; color: #999; display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid var(--sidebar-border); }

        /* --- Main Layout --- */
        #main-container { flex: 1; display: flex; flex-direction: column; position: relative; }
        #reader-viewport { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        #content-area { flex: 1; padding: 0 60px; }
        
        .zen-mode #content-area { max-width: 800px; margin: 15vh auto 5vh auto; font-size: 24px; line-height: 1.8; }
        .scroll-mode #content-area { max-width: 800px; margin: 40px auto; font-size: 18px; line-height: 1.6; }

        /* --- Note System --- */
        .note-container { max-width: 800px; margin: 0 auto 40px auto; padding: 0 60px; width: 100%; box-sizing: border-box; }
        .note-display { font-size: 14px; color: var(--note-color); padding: 15px; background: var(--sidebar-bg); border-radius: 8px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; font-style: italic; position: relative; }
        .note-display:hover { border-color: var(--accent); }
        .note-display::before { content: "NOTE"; font-size: 9px; font-weight: bold; position: absolute; top: -8px; left: 10px; background: var(--bg-color); padding: 0 5px; color: var(--accent); font-style: normal; }

        #note-editor-wrapper { position: relative; margin-top: 20px; }
        #note-input { width: 100%; height: 120px; padding: 12px; padding-bottom: 45px; border-radius: 8px; border: 1px solid var(--accent); background: var(--bg-color); color: var(--text-color); font-family: inherit; resize: none; box-sizing: border-box; font-size: 14px; outline: none; line-height: 1.5; }
        .save-note-btn { position: absolute; right: 10px; bottom: 10px; background: var(--accent); color: white; border: none; padding: 6px 15px; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: bold; opacity: 0.9; }
        .save-note-btn:hover { opacity: 1; }
        .shortcut-hint { position: absolute; left: 12px; bottom: 12px; font-size: 9px; opacity: 0.4; color: var(--text-color); pointer-events: none; }

        /* --- Scroll Mode --- */
        .scroll-section { position: relative; padding: 15px 40px; border-radius: 8px; border-left: 3px solid transparent; }
        .scroll-section:hover { background: var(--btn-hover); border-left-color: var(--accent); }
        .focus-trigger { position: absolute; left: 10px; top: 20px; cursor: pointer; opacity: 0; }
        .scroll-section:hover .focus-trigger { opacity: 1; }

        /* --- Modal & Nav --- */
        #outline-modal { position: absolute; inset: 0; background: var(--modal-bg); backdrop-filter: blur(15px); display: none; flex-direction: column; padding: 40px; z-index: 100; }
        #outline-list { flex: 1; overflow-y: auto; max-width: 700px; margin: 0 auto; width: 100%; }
        .outline-link { padding: 8px 15px; cursor: pointer; border-radius: 6px; }
        .outline-link:hover { background: var(--accent); color: white; }
        
        #nav-controls { height: 80px; display: flex; border-top: 1px solid var(--sidebar-border); background: var(--sidebar-bg); }
        .nav-btn { flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; opacity: 0.7; user-select: none; }
        .nav-btn:hover { background: var(--btn-hover); opacity: 1; }
        .progress-box { width: 220px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; background: var(--bg-color); border-left: 1px solid var(--sidebar-border); border-right: 1px solid var(--sidebar-border); }
    </style>
</head>
<body class="zen-mode">

<div id="sidebar">
    <div class="nav-header">Library</div>
    <div class="upload-section">
        <button class="btn" onclick="document.getElementById('fileInput').click()" style="font-weight: bold;">+ Import MD</button>
        <div class="btn-row">
            <button class="btn" onclick="exportData()">Export</button>
            <button class="btn" onclick="document.getElementById('backupInput').click()">Import</button>
        </div>
    </div>
    <input type="file" id="fileInput" style="display:none" onchange="handleFile(this, 'md')">
    <input type="file" id="backupInput" style="display:none" onchange="handleFile(this, 'json')">
    <div id="file-list"></div>
    <div class="storage-info">
        <span><span id="storageSize">0</span> KB</span>
        <span onclick="clearAll()" style="color:#ff4d4f; cursor:pointer">Purge</span>
    </div>
</div>

<div id="main-container">
    <div id="outline-modal">
        <div id="outline-list"></div>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
            <button class="btn" id="modeBtn" style="width:240px; background:var(--accent); color:white" onclick="toggleMode()">Switch to Scroll Mode</button>
            <button class="btn" style="width:100px" onclick="closeOutline()">Close</button>
        </div>
    </div>

    <div id="reader-viewport">
        <div id="content-area"></div>
        <div class="note-container" id="note-zone">
            <div id="note-view" class="note-display" style="display: none;" onclick="editNote()"></div>
            <div id="note-editor-wrapper">
                <textarea id="note-input" placeholder="Type your thoughts here..."></textarea>
                <div class="shortcut-hint">âŒ˜/Ctrl + Enter to save</div>
                <button class="save-note-btn" onclick="saveNote()">SAVE</button>
            </div>
        </div>
    </div>

    <div id="nav-controls">
        <div class="nav-btn" onclick="changePage(-1)">PREVIOUS</div>
        <div class="progress-box" onclick="openOutline()">
            <div id="pageNum" style="font-size: 20px; font-weight: bold;">0 / 0</div>
        </div>
        <div class="nav-btn" onclick="changePage(1)">NEXT</div>
    </div>
</div>

<script>
    let state = { files: {}, meta: {}, current: null, isScroll: false, paragraphs: [] };

    function init() {
        const f = localStorage.getItem('zen_files'), m = localStorage.getItem('zen_meta'), last = localStorage.getItem('zen_last_file');
        if(f) state.files = JSON.parse(f);
        if(m) state.meta = JSON.parse(m);
        renderFileList(); updateStorageSize();
        if (last && state.files[last]) openBook(last);

        // Add Global Key Listeners
        window.addEventListener('keydown', handleGlobalKeydown);
    }

    function openBook(name) {
        state.current = name;
        localStorage.setItem('zen_last_file', name);
        state.paragraphs = state.files[name].split(/\n+/).filter(p => p.trim() !== '');
        if(!state.meta[name]) state.meta[name] = { index: 0, notes: {} };
        state.isScroll = false;
        document.body.className = 'zen-mode';
        document.getElementById('nav-controls').style.display = 'flex';
        render(); renderFileList();
    }

    function render() {
        if(!state.current) return;
        const area = document.getElementById('content-area');
        const noteZone = document.getElementById('note-zone');
        const idx = state.meta[state.current].index;
        const notes = state.meta[state.current].notes || {};

        if(state.isScroll) {
            noteZone.style.display = 'none';
            area.innerHTML = state.paragraphs.map((p, i) => {
                const n = notes[i] ? `<div class="note-display" style="margin-top:10px; cursor:default">${notes[i]}</div>` : '';
                return `<div class="scroll-section" id="s-${i}"><span class="focus-trigger" onclick="goZen(${i})">ðŸŽ¯</span>${safeMarkdown(p)}${n}</div>`;
            }).join('');
            setTimeout(() => { const t = document.getElementById(`s-${idx}`); if(t) t.scrollIntoView(); }, 50);
        } else {
            noteZone.style.display = 'block';
            area.innerHTML = safeMarkdown(state.paragraphs[idx]);
            document.getElementById('pageNum').innerText = `${idx + 1} / ${state.paragraphs.length}`;
            updateNoteUI(notes[idx]);
            document.getElementById('reader-viewport').scrollTop = 0;
        }
        save();
    }

    function updateNoteUI(content) {
        const view = document.getElementById('note-view');
        const editor = document.getElementById('note-editor-wrapper');
        const input = document.getElementById('note-input');
        if(content) {
            view.innerText = content;
            view.style.display = 'block';
            editor.style.display = 'none';
        } else {
            view.style.display = 'none';
            editor.style.display = 'block';
            input.value = "";
        }
    }

    function editNote() {
        document.getElementById('note-view').style.display = 'none';
        document.getElementById('note-editor-wrapper').style.display = 'block';
        const input = document.getElementById('note-input');
        input.value = state.meta[state.current].notes[state.meta[state.current].index];
        input.focus();
    }

    function saveNote() {
        const text = document.getElementById('note-input').value.trim();
        const idx = state.meta[state.current].index;
        state.meta[state.current].notes[idx] = text;
        render();
    }

    function handleGlobalKeydown(e) {
        // Fast Save: Command+Enter or Ctrl+Enter
        if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
            if (document.activeElement.id === 'note-input') {
                saveNote();
                e.preventDefault();
            }
            return;
        }

        // Page Navigation (Only if not typing)
        if(document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'INPUT') return;
        
        if(e.key === 'ArrowRight' || e.key === 'PageDown') changePage(1);
        if(e.key === 'ArrowLeft' || e.key === 'PageUp') changePage(-1);
        if(e.key === 'Escape') closeOutline();
    }

    function safeMarkdown(text) { return window.marked ? marked.parse(text) : text; }

    function changePage(dir) {
        if(!state.current || state.isScroll) return;
        const newIdx = state.meta[state.current].index + dir;
        if(newIdx >= 0 && newIdx < state.paragraphs.length) {
            state.meta[state.current].index = newIdx;
            render();
        }
    }

    function toggleMode() {
        state.isScroll = !state.isScroll;
        document.body.className = state.isScroll ? 'scroll-mode' : 'zen-mode';
        document.getElementById('modeBtn').innerText = state.isScroll ? 'Switch to Zen Mode' : 'Switch to Scroll Mode';
        document.getElementById('nav-controls').style.display = state.isScroll ? 'none' : 'flex';
        closeOutline(); render();
    }

    function goZen(idx) { state.meta[state.current].index = idx; state.isScroll = false; document.body.className = 'zen-mode'; document.getElementById('nav-controls').style.display = 'flex'; render(); }

    function openOutline() {
        if(!state.current) return;
        const list = document.getElementById('outline-list');
        list.innerHTML = '';
        state.paragraphs.forEach((p, i) => {
            const h = p.trim().match(/^(#{1,6})\s+(.+)$/m);
            if(h) {
                const div = document.createElement('div');
                div.className = `outline-link h${h[1].length}`;
                div.innerText = h[2];
                div.onclick = () => {
                    state.meta[state.current].index = i;
                    if(state.isScroll) { closeOutline(); document.getElementById(`s-${i}`).scrollIntoView(); }
                    else { render(); closeOutline(); }
                };
                list.appendChild(div);
            }
        });
        document.getElementById('outline-modal').style.display = 'flex';
    }

    function closeOutline() { document.getElementById('outline-modal').style.display = 'none'; }

    function handleFile(input, type) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            if(type === 'md') {
                state.files[file.name] = e.target.result;
                state.meta[file.name] = { index: 0, notes: {} };
                save(); renderFileList(); openBook(file.name);
            } else {
                const data = JSON.parse(e.target.result);
                state.files = data.files; state.meta = data.meta;
                save(); location.reload();
            }
        };
        reader.readAsText(file);
        input.value = '';
    }

    function renderFileList() {
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        Object.keys(state.files).forEach(name => {
            const item = document.createElement('div');
            item.className = `file-item ${state.current === name ? 'active' : ''}`;
            item.innerHTML = `<span style="flex:1; overflow:hidden; text-overflow:ellipsis">${name}</span>
                              <span onclick="deleteFile(event, '${name}')" style="opacity:0.3;cursor:pointer">âœ•</span>`;
            item.onclick = () => openBook(name);
            list.appendChild(item);
        });
    }

    function deleteFile(e, name) {
        e.stopPropagation(); if(!confirm('Delete file?')) return;
        delete state.files[name]; delete state.meta[name];
        if(state.current === name) localStorage.removeItem('zen_last_file');
        save(); location.reload();
    }

    function save() {
        localStorage.setItem('zen_files', JSON.stringify(state.files));
        localStorage.setItem('zen_meta', JSON.stringify(state.meta));
        updateStorageSize();
    }

    function updateStorageSize() {
        let size = 0;
        for(let k in localStorage) if(localStorage.hasOwnProperty(k)) size += localStorage[k].length;
        document.getElementById('storageSize').innerText = Math.round(size * 2 / 1024);
    }

    function clearAll() { if(confirm('Purge all data?')) { localStorage.clear(); location.reload(); } }

    function exportData() {
        const b = JSON.stringify({files: state.files, meta: state.meta});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([b], {type:'application/json'}));
        a.download = `Zen_Backup_${new Date().getTime()}.json`; a.click();
    }

    init();
</script>
</body>
</html>
